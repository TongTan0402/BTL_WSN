<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard IoT Rimuru - Multi Location</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        .gauge-wrapper { position: relative; padding-bottom: 20px; max-width: 100%; }
        .gauge-value-display {
            position: absolute; top: 55%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem; font-weight: 700;
        }
        .chart-container { height: 220px; max-width: 100%; }
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 20px;
        }
        #status {
            display: flex;
            justify-content: space-around; /* dÃ n Ä‘á»u 3 cá»¥m */
            align-items: center;
            gap: 20px; /* khoáº£ng cÃ¡ch giá»¯a cÃ¡c cá»¥m */
        }
    </style>
</head>
<body class="font-sans min-h-screen p-4 md:p-8 bg-slate-100">

<button id="export" class="fixed top-4 left-4 md:top-6 md:left-6 p-2 md:px-4 md:py-2 text-sm md:text-base font-semibold bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-lg transition duration-150 z-10">
    â¬‡ Xuáº¥t Excel
</button>

<h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-8 mt-16 text-center">Dashboard IoT Rimuru</h1>

<!-- Tráº¡ng thÃ¡i káº¿t ná»‘i -->
<div id="status" class="text-center mb-8 p-3 rounded-lg font-medium shadow-md bg-yellow-100 text-yellow-700 border border-yellow-300">
    ğŸŸ¡ Äang táº£i dá»¯ liá»‡u tá»« Google Sheets...
</div>

<!-- Khu vá»±c hiá»ƒn thá»‹ tá»«ng Ä‘á»‹a Ä‘iá»ƒm -->
<div id="dashboard"></div>

<script>
const GOOGLE_SHEET_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwhTF9oBVzyj8QJrQak8oJ33r3Y5sb9E3t3pU96MB9cQt6CT6TCBKiZiFTQa9Oolbc/exec";
const REFRESH_INTERVAL_SECONDS = 3;
const LOCATIONS = ['A101', 'B202', 'C303'];

let dataLogAll = {}; 
let allCharts = {};  

const chartColors = {
    temp: { primary: '#ef4444', text: '#dc2626' },
    humid: { primary: '#06b6d4', text: '#0891b2' },
    pm25: { primary: '#f59e0b', text: '#d97706' },
    gas: { primary: '#c026d3', text: '#a21caf' }
};

// ====== LÆ¯U THá»œI GIAN Cáº¬P NHáº¬T ======
const updateTimes = {
    A101: "--:--:--",
    B202: "--:--:--",
    C303: "--:--:--"
};

// ====== Cáº¬P NHáº¬T DÃ’NG TRáº NG THÃI ======
function updateStatusLine() {
    const el = document.getElementById('status');
    el.className = "text-center mb-8 p-3 rounded-lg font-medium shadow-md border bg-green-100 text-green-700 border-green-300";
    el.innerHTML = `
        <span>ğŸŸ¢ A101: ${updateTimes.A101}</span>
        <span>ğŸŸ¢ B202: ${updateTimes.B202}</span>
        <span>ğŸŸ¢ C303: ${updateTimes.C303}</span>
    `;
}

// ====== KHá»I Táº O DASHBOARD ======
function renderDashboard() {
    const dash = document.getElementById('dashboard');
    dash.innerHTML = '';
    LOCATIONS.forEach(loc => {
        const section = document.createElement('section');
        section.className = "mb-10";
        section.innerHTML = `
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center border-b-2 border-indigo-400 pb-2">
                ğŸ“ Äá»‹a Ä‘iá»ƒm: ${loc}
            </h2>
            <div class="grid-container" id="grid-${loc}">
                ${createCardHTML(loc, 'temp', 'ğŸŒ¡ï¸ Nhiá»‡t Ä‘á»™ (Â°C)', 'Â°C', 'text-red-600')}
                ${createCardHTML(loc, 'humid', 'ğŸ’§ Äá»™ áº©m (%)', '%', 'text-cyan-600')}
                ${createCardHTML(loc, 'pm25', 'ğŸŒ«ï¸ Bá»¥i PM2.5 (Âµg/mÂ³)', 'Âµg/mÂ³', 'text-amber-600')}
                ${createCardHTML(loc, 'gas', 'ğŸ”¥ KhÃ­ Gas (PPM)', 'PPM', 'text-fuchsia-600')}
            </div>`;
        dash.appendChild(section);
    });
}

function createCardHTML(loc, id, label, unit, textColor) {
    return `
    <div class="bg-white p-6 rounded-xl shadow-xl hover:shadow-2xl transition duration-300">
        <h3 class="text-lg font-bold text-gray-700 mb-3 border-b pb-2 flex items-center">
            <span class="mr-2">${label.split(' ')[0]}</span> ${label.slice(2)}
        </h3>
        <div class="gauge-wrapper">
            <div class="chart-container"><canvas id="gauge-${loc}-${id}"></canvas></div>
            <div id="value-${loc}-${id}" class="gauge-value-display ${textColor}">--</div>
        </div>
        <div class="chart-container"><canvas id="line-${loc}-${id}"></canvas></div>
    </div>`;
}

// ====== BIá»‚U Äá»’ ======
function createGauge(ctx, max, color){
    return new Chart(ctx, {
        type: 'doughnut',
        data: { datasets:[{ data:[0, max], backgroundColor:[color, '#e5e7eb'], borderWidth: 0 }] },
        options: {
            responsive:true, maintainAspectRatio:false,
            circumference:180, rotation:270, cutout:'80%',
            plugins:{ tooltip:{enabled:false}, legend:{display:false} }
        }
    });
}
function createLine(ctx, label, color){
    return new Chart(ctx,{
        type:'line',
        data:{ labels:[], datasets:[{ label, data:[], borderColor:color, tension:0.4, pointRadius:3, pointBackgroundColor:color, fill:false }] },
        options:{
            responsive:true, maintainAspectRatio:false,
            scales:{ x:{grid:{display:false}}, y:{beginAtZero:true} },
            plugins:{ legend:{display:false} }
        }
    });
}

// ====== KHá»I Táº O BIá»‚U Äá»’ ======
function initAllCharts(){
    LOCATIONS.forEach(loc=>{
        allCharts[loc] = {
            temp: { gauge:createGauge(document.getElementById(`gauge-${loc}-temp`),50,chartColors.temp.primary), line:createLine(document.getElementById(`line-${loc}-temp`),'Nhiá»‡t Ä‘á»™',chartColors.temp.primary), max:50, valueEl:document.getElementById(`value-${loc}-temp`), unit:'Â°C'},
            humid:{ gauge:createGauge(document.getElementById(`gauge-${loc}-humid`),100,chartColors.humid.primary), line:createLine(document.getElementById(`line-${loc}-humid`),'Äá»™ áº©m',chartColors.humid.primary), max:100, valueEl:document.getElementById(`value-${loc}-humid`), unit:'%'},
            pm25:{ gauge:createGauge(document.getElementById(`gauge-${loc}-pm25`),300,chartColors.pm25.primary), line:createLine(document.getElementById(`line-${loc}-pm25`),'PM2.5',chartColors.pm25.primary), max:300, valueEl:document.getElementById(`value-${loc}-pm25`), unit:'Âµg/mÂ³'},
            gas:{ gauge:createGauge(document.getElementById(`gauge-${loc}-gas`),1000,chartColors.gas.primary), line:createLine(document.getElementById(`line-${loc}-gas`),'KhÃ­ Gas',chartColors.gas.primary), max:1000, valueEl:document.getElementById(`value-${loc}-gas`), unit:'PPM'}
        };
    });
}

// ====== Cáº¬P NHáº¬T Dá»® LIá»†U ======
function updateCharts(locationId, records){
    dataLogAll[locationId] = records;
    const lineData = { temp:[], humid:[], pm25:[], gas:[], timestamps:[] };
    records.forEach(r=>{
        const t = new Date(r.timestamp);
        const timeStr = !isNaN(t) ? t.toLocaleTimeString('vi-VN',{hour12:false}) : r.timestamp;
        lineData.timestamps.push(timeStr);
        lineData.temp.push(parseFloat(r.temp));
        lineData.humid.push(parseFloat(r.humid));
        lineData.pm25.push(parseFloat(r.pm25));
        lineData.gas.push(parseFloat(r.gas));
    });
    const charts = allCharts[locationId];
    for (const k in charts){
        charts[k].line.data.labels = lineData.timestamps;
        charts[k].line.data.datasets[0].data = lineData[k];
        charts[k].line.update();
    }
    const latest = records[records.length-1];
    if (latest){
        for (const k in charts){
            const val = parseFloat(latest[k]).toFixed(1);
            charts[k].gauge.data.datasets[0].data = [val, charts[k].max - val];
            charts[k].gauge.update();
            charts[k].valueEl.innerText = `${val}${charts[k].unit}`;
        }
    }
}

// ====== FETCH Dá»® LIá»†U ======
async function fetchDataFromSheets(locationId){
    try{
        const res=await fetch(`${GOOGLE_SHEET_WEB_APP_URL}?location=${locationId}`);
        const result=await res.json();
        if(result.result==="success"){
            updateCharts(locationId,result.data);
            updateTimes[locationId] = new Date().toLocaleTimeString('vi-VN',{hour12:false});
            updateStatusLine();
        }else{
            console.error(result.message);
        }
    }catch(e){
        console.error(e);
    }
}

// ====== CHU Ká»² LÃ€M Má»šI ======
function startAutoRefresh(){
    const loadAll=()=>LOCATIONS.forEach(loc=>fetchDataFromSheets(loc));
    loadAll();
    setInterval(loadAll, REFRESH_INTERVAL_SECONDS*1000);
}

// ====== XUáº¤T EXCEL ======
document.getElementById('export').onclick=function(){
    let allData=[];
    for(const loc of LOCATIONS){
        const data=dataLogAll[loc]||[];
        allData=allData.concat(data.map(d=>({
            'Äá»‹a Ä‘iá»ƒm':loc,
            'Thá»i gian':d.timestamp,
            'Nhiá»‡t Ä‘á»™ (Â°C)':d.temp,
            'Äá»™ áº©m (%)':d.humid,
            'PM2.5 (Âµg/mÂ³)':d.pm25,
            'KhÃ­ Gas (PPM)':d.gas
        })));
    }
    if(allData.length===0)return alert("ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ xuáº¥t Excel!");
    const ws=XLSX.utils.json_to_sheet(allData);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,'Tá»•ng há»£p');
    XLSX.writeFile(wb,`sensor_log_all_${new Date().toISOString().slice(0,10)}.xlsx`);
};

// ====== KHá»I Äá»˜NG ======
window.onload=()=>{
    renderDashboard();
    initAllCharts();
    updateStatusLine();
    startAutoRefresh();
};
</script>
</body>
</html>
